<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: sans-serif; background: #f4f7f9; display: flex; justify-content: center; padding: 20px; }
    .card { background: white; width: 100%; max-width: 500px; padding: 25px; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
    .tabs { display: flex; margin-bottom: 20px; border-bottom: 2px solid #eee; }
    .tab { flex: 1; padding: 12px; text-align: center; cursor: pointer; color: #888; }
    .tab.active { color: #1a73e8; border-bottom: 3px solid #1a73e8; font-weight: bold; }
    .form-group { display: none; }
    .form-group.active { display: block; }
    label { display: block; margin-top: 15px; font-weight: bold; font-size: 14px; }
    input, select { width: 100%; padding: 12px; margin-top: 5px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; }
    .btn { width: 100%; background: #1a73e8; color: white; padding: 14px; border: none; border-radius: 6px; margin-top: 25px; cursor: pointer; font-size: 16px; }
    #msg { margin-top: 15px; padding: 12px; border-radius: 6px; text-align: center; font-weight: bold; display: none; }
    .hidden { display: none; }
  </style>
</head>
<body>
  <div class="card">
    <div class="tabs">
      <div class="tab active" onclick="switchTab('project')">客戶工程案號</div>
      <div class="tab" onclick="switchTab('vendor')">廠商品號系統</div>
    </div>
    <div id="msg"></div>

    <div id="project-form" class="form-group active">
      <label>搜尋客戶 (輸入代號或名稱)</label>
      <input list="custList" id="p_search" placeholder="打字篩選...">
      <datalist id="custList"></datalist>
      
      <label>手動改 D 案?</label>
      <select id="p_d"><option value="否">否 (依金額自動 A/B/C)</option><option value="是">是 (設備銷售 D)</option></select>
      
      <label>合約金額</label>
      <input type="number" id="p_amt" placeholder="請輸入金額">
      
      <label>合約名稱/備註</label>
      <input type="text" id="p_name" placeholder="例如: 某某工程案">
      
      <button class="btn" onclick="saveProject()">產生案號並歸檔</button>
    </div>

    <div id="vendor-form" class="form-group">
      <label>搜尋廠商 (輸入代號或名稱)</label>
      <input list="vendList" id="v_search" placeholder="打字篩選...">
      <datalist id="vendList"></datalist>

      <label>性質</label>
      <select id="v_prop" onchange="toggleCity()">
        <option value="承攬(連工帶料)">承攬(連工帶料) (7A)</option>
        <option value="工資">工資 (7B)</option>
        <option value="工案吊車費">工案吊車費 (7C1)</option>
        <option value="工案運輸費">工案運輸費 (7C2)</option>
      </select>

      <div id="city-group" class="hidden">
        <label>縣市區域</label>
        <select id="v_city">
          <option value="">請選擇</option>
          <option>台北</option><option>桃園</option><option>新竹</option><option>台中</option><option>高雄</option><option>台南</option>
          <option>宜蘭</option><option>花蓮</option><option>台東</option><option>離島</option><option>苗栗</option><option>彰化</option>
          <option>南投</option><option>雲林</option><option>嘉義</option><option>屏東</option><option>基隆</option>
        </select>
      </div>

      <label>品項名稱/備註</label>
      <input type="text" id="v_name" placeholder="例如: 紘展-XX工程工資">
      
      <button class="btn" onclick="saveVendor()">產生品號並歸檔</button>
    </div>
  </div>

  <script>
    const API_URL = "https://script.google.com/macros/library/d/1Ui-euy_oge-HdvvPZHJVU8S1W1Sd8veyngguHiD72LvZ1XkDrSWSQAv4/3"; // ***請務必替換***

    window.onload = () => {
  // 網頁開啟立刻抓取主檔
  fetchData("getDropdownData", {}, (data) => {
    const cList = document.getElementById('custList');
    const vList = document.getElementById('vendList');
    
    // 清空並重新填充
    cList.innerHTML = "";
    vList.innerHTML = "";

    // 格式優化：代號 - 名稱，方便打第一個字就配對
    data.customers.forEach(c => {
      let opt = document.createElement('option');
      opt.value = c.id;
      opt.label = c.name; 
      cList.appendChild(opt);
    });

    data.vendors.forEach(v => {
      let opt = document.createElement('option');
      opt.value = v.id;
      opt.label = v.name;
      vList.appendChild(opt);
    });
    console.log("主檔資料載入完成");
  });
};

// 監聽性質切換：只有吊車(7C1)與運輸(7C2)顯示縣市
function toggleCity() {
  const prop = document.getElementById('v_prop').value;
  const is7C = prop.includes('吊車') || prop.includes('運輸');
  document.getElementById('city-group').style.display = is7C ? 'block' : 'none';
}

    async function fetchData(action, data, cb) {
      const res = await fetch(API_URL, { method: "POST", body: JSON.stringify({ action, data }) });
      const json = await res.json();
      if (json.status === "success") cb(json.data);
      else alert("錯誤: " + json.message);
    }

    function switchTab(t) {
      document.getElementById('project-form').className = t === 'project' ? 'form-group active' : 'form-group';
      document.getElementById('vendor-form').className = t === 'vendor' ? 'form-group active' : 'form-group';
      document.querySelectorAll('.tab').forEach((el, i) => el.className = (i === (t==='project'?0:1)) ? 'tab active' : 'tab');
    }

    function saveProject() {
      const data = {
        customerID: document.getElementById('p_search').value,
        isCaseD: document.getElementById('p_d').value,
        amount: document.getElementById('p_amt').value,
        itemName: document.getElementById('p_name').value
      };
      fetchData("submitProject", data, (id) => showMsg("成功！案號：" + id));
    }

    function saveVendor() {
      const data = {
        vendorID: document.getElementById('v_search').value,
        property: document.getElementById('v_prop').value,
        city: document.getElementById('v_city').value,
        itemName: document.getElementById('v_name').value
      };
      fetchData("submitVendor", data, (id) => showMsg("成功！品號：" + id));
    }

    function showMsg(m) {
      const el = document.getElementById('msg');
      el.innerText = m; el.style.display = 'block'; el.style.background = '#d4edda';
    }
  </script>
</body>
</html>
