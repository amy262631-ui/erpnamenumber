<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <style>
    body { font-family: sans-serif; background: #f0f2f5; display: flex; flex-direction: column; align-items: center; padding: 20px; }
    .card { background: white; width: 100%; max-width: 550px; padding: 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin-bottom: 20px; }
    .tabs { display: flex; margin-bottom: 20px; border-bottom: 2px solid #eee; }
    .tab { flex: 1; padding: 15px; text-align: center; cursor: pointer; color: #888; font-size: 18px; }
    .tab.active { color: #1a73e8; border-bottom: 3px solid #1a73e8; font-weight: bold; }
    label { display: block; margin-top: 15px; font-weight: bold; font-size: 18px; }
    input, select { width: 100%; padding: 15px; margin-top: 5px; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; font-size: 20px; }
    .btn { width: 100%; background: #1a73e8; color: white; padding: 18px; border: none; border-radius: 8px; margin-top: 25px; cursor: pointer; font-size: 20px; font-weight: bold; }
    .history { width: 100%; max-width: 900px; background: white; padding: 20px; border-radius: 10px; overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border-bottom: 1px solid #eee; padding: 12px; text-align: left; }
    th { background: #f8f9fa; }
    .hidden { display: none; }
  </style>
</head>
<body>
  <div class="card">
    <div class="tabs">
      <div class="tab active" onclick="switchTab('project')">客戶工程</div>
      <div class="tab" onclick="switchTab('vendor')">廠商品號</div>
    </div>
    <div id="project-form">
      <label>搜尋客戶 (輸入代號或名稱)</label>
      <input list="custList" id="p_search" placeholder="打字自動篩選...">
      <datalist id="custList"></datalist>
      <label>金額 (自動千分位)</label>
      <input type="text" id="p_amt_show" oninput="formatAmt(this)" placeholder="請輸入金額">
      <input type="hidden" id="p_amt">
      <label>專案名稱</label>
      <input type="text" id="p_item" placeholder="請輸入合約名稱">
      <label>強制 D 案?</label>
      <select id="p_d"><option value="否">否</option><option value="是">是</option></select>
      <button class="btn" onclick="saveP()">產生並歸檔</button>
    </div>
    <div id="vendor-form" class="hidden">
      <label>搜尋廠商</label>
      <input list="vendList" id="v_search" placeholder="打字自動篩選...">
      <datalist id="vendList"></datalist>
      <label>性質</label>
      <select id="v_prop" onchange="checkCity()"><option>承攬(連工帶料)</option><option>工資</option><option>工案吊車費</option><option>工案運輸費</option></select>
      <div id="v_city_box" class="hidden"><label>區域</label><select id="v_city"><option>台北</option><option>桃園</option><option>新竹</option><option>台中</option><option>高雄</option><option>台南</option><option>苗栗</option><option>彰化</option><option>南投</option><option>雲林</option><option>嘉義</option><option>屏東</option><option>宜蘭</option><option>花蓮</option><option>台東</option><option>基隆</option><option>離島</option></select></div>
      <label>品項名稱</label>
      <input type="text" id="v_item" placeholder="例如: 紘展-XX工程工資">
      <button class="btn" onclick="saveV()">產生並歸檔</button>
    </div>
  </div>
  <div class="history"><h3>最近明細紀錄</h3><table id="hTable"><thead><tr id="hHead"></tr></thead><tbody id="hBody"></tbody></table></div>

  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbylFcjL1lhcDPRLgCS8ChlsDHOQ273SyIsNDGe65mThL0vjafFfTe3McX4dvbiLjDc3/exec";
    let curTab = 'project';

    function formatAmt(el) {
      let val = el.value.replace(/[^0-9]/g, '');
      document.getElementById('p_amt').value = val;
      el.value = val ? Number(val).toLocaleString() : '';
    }

    function checkCity() {
      const p = document.getElementById('v_prop').value;
      document.getElementById('v_city_box').className = p.includes('吊車') || p.includes('運輸') ? '' : 'hidden';
    }

    async function call(action, data) {
      const res = await fetch(API_URL, { method: "POST", body: JSON.stringify({ action, data }) });
      return (await res.json()).data;
    }

    window.onload = async () => {
      const d = await call("getInitialData", {});
      d.customers.forEach(c => document.getElementById('custList').innerHTML += `<option value="${c.id}">${c.name}</option>`);
      d.vendors.forEach(v => document.getElementById('vendList').innerHTML += `<option value="${v.id}">${v.name}</option>`);
      render(d.projectHistory, 'project');
    };

    function render(rows, type) {
      const head = document.getElementById('hHead'), body = document.getElementById('hBody');
      head.innerHTML = type === 'project' ? "<th>日期</th><th>案號</th><th>客戶</th><th>金額</th><th>專案名稱</th>" : "<th>日期</th><th>品號</th><th>廠商</th><th>性質</th><th>品項名稱</th>";
      body.innerHTML = rows.map(r => `<tr><td>${r[0]}</td><td>${r[1]}</td><td>${r[2]}</td><td>${type==='project'?Number(r[3]).toLocaleString():r[3]}</td><td>${r[5]}</td></tr>`).join('');
    }

    function switchTab(t) {
      curTab = t;
      document.getElementById('project-form').className = t === 'project' ? '' : 'hidden';
      document.getElementById('vendor-form').className = t === 'vendor' ? '' : 'hidden';
      document.querySelectorAll('.tab').forEach((el, i) => el.className = (i===(t==='project'?0:1)) ? 'tab active' : 'tab');
      call("getHistory", {type: t}).then(rows => render(rows, t));
    }

    async function saveP() {
      const id = await call("submitProject", { customerID: document.getElementById('p_search').value, amount: document.getElementById('p_amt').value, itemName: document.getElementById('p_item').value, isCaseD: document.getElementById('p_d').value });
      alert("成功產生案號：" + id); location.reload();
    }

    async function saveV() {
      const id = await call("submitVendor", { vendorID: document.getElementById('v_search').value, property: document.getElementById('v_prop').value, city: document.getElementById('v_city').value, itemName: document.getElementById('v_item').value });
      alert("成功產生品號：" + id); location.reload();
    }
  </script>
</body>
</html>
